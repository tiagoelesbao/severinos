# =============================================================================
# AIOS PR Automation
# =============================================================================
# Generated by: *setup-github task
# =============================================================================

name: PR Automation

on:
  pull_request:
    branches:
      - main
      - develop
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write

env:
  NODE_VERSION: '22'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm run lint

  typecheck:
    name: TypeCheck
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - run: npm run typecheck

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      coverage-summary: ${{ steps.coverage.outputs.summary }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - run: npm ci
      - id: test-run
        run: npm run test
      - uses: codecov/codecov-action@v4
        with:
          fail_ci_if_error: false
      - id: coverage
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)
            echo "summary=Lines: ${LINES}%" >> $GITHUB_OUTPUT
          else
            echo "summary=Coverage report not available" >> $GITHUB_OUTPUT
          fi

  coverage-comment:
    name: Coverage Comment
    runs-on: ubuntu-latest
    needs: [test]
    if: always() && needs.test.result != 'cancelled'
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const coverageSummary = '${{ needs.test.outputs.coverage-summary }}' || 'Coverage data not available';
            const body = `## ğŸ“Š Coverage Report\n\n${coverageSummary}`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(comment => comment.user.type === 'Bot' && comment.body.includes('ğŸ“Š Coverage Report'));
            if (botComment) {
              await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: botComment.id, body });
            } else {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body });
            }

  quality-summary:
    name: Quality Summary
    runs-on: ubuntu-latest
    needs: [lint, typecheck, test]
    if: always()
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const lintResult = '${{ needs.lint.result }}';
            const typecheckResult = '${{ needs.typecheck.result }}';
            const testResult = '${{ needs.test.result }}';
            const getEmoji = (res) => res === 'success' ? 'âœ…' : 'âŒ';
            const body = `## ğŸ“‹ Quality Gate Summary\n\n| Check | Status |\n|-------|--------|\n| Lint | ${getEmoji(lintResult)} |\n| TypeCheck | ${getEmoji(typecheckResult)} |\n| Tests | ${getEmoji(testResult)} |`;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const botComment = comments.find(comment => comment.user.type === 'Bot' && comment.body.includes('ğŸ“‹ Quality Gate Summary'));
            if (botComment) {
              await github.rest.issues.updateComment({ owner: context.repo.owner, repo: context.repo.repo, comment_id: botComment.id, body });
            } else {
              await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: context.issue.number, body });
            }

  coderabbit-check:
    name: CodeRabbit Status
    runs-on: ubuntu-latest
    steps:
      - run: echo "ğŸ° CodeRabbit Integration Active"
